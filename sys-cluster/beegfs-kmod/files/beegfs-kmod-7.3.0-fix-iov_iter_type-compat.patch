From 4ad6fb622b45f7e28e3c493672ef5978f3cb45c4 Mon Sep 17 00:00:00 2001
From: Timo Rothenpieler <timo.rothenpieler@uni-bremen.de>
Date: Fri, 20 May 2022 00:48:03 +0200
Subject: [PATCH] Fix iov_iter_type compat

---
 client_module/source/os/iov_iter.h | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/client_module/source/os/iov_iter.h b/client_module/source/os/iov_iter.h
index e40dfdc..b7fd389 100644
--- a/client_module/source/os/iov_iter.h
+++ b/client_module/source/os/iov_iter.h
@@ -25,7 +25,7 @@
 #endif
 
 #ifndef KERNEL_HAS_IOV_ITER_TYPE
-#ifdef KERNEL_HAS_ITER_KVEC
+#if defined(KERNEL_HAS_ITER_KVEC) || defined(KERNEL_HAS_ITER_PIPE)
 static inline int iov_iter_type(const struct iov_iter *i)
 {
    return i->type & ~(READ | WRITE);
@@ -233,7 +233,7 @@ typedef struct
 static inline int beegfs_iov_iter_is_iovec(const BeeGFS_IovIter *iter)
 {
 #ifdef KERNEL_HAS_IOV_ITER_TYPE
-   return iter->_iov_iter.type == ITER_IOVEC;
+   return iov_iter_type(&iter->_iov_iter) == ITER_IOVEC;
 #else
    return !iter->is_kvec;
 #endif
@@ -305,7 +305,7 @@ static inline void beegfs_iov_iter_advance(BeeGFS_IovIter *iter, size_t bytes)
 static inline bool beegfs_is_pipe_iter(BeeGFS_IovIter * iter)
 {
 #ifdef KERNEL_HAS_ITER_PIPE
-   return iter->_iov_iter.type & ITER_PIPE;
+   return iov_iter_type(&iter->_iov_iter) & ITER_PIPE;
 #else
    return false;
 #endif
-- 
2.35.1

