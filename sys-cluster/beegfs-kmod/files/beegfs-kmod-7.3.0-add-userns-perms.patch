From f37a13305a67fed28d2b3c0078aa963a8ec72733 Mon Sep 17 00:00:00 2001
From: Timo Rothenpieler <timo.rothenpieler@uni-bremen.de>
Date: Fri, 20 May 2022 01:36:34 +0200
Subject: [PATCH] Add support for userns

---
 client_module/build/KernelFeatureDetection.mk | 3 +++
 client_module/source/os/OsCompat.h            | 3 +++
 2 files changed, 6 insertions(+)

diff --git a/client_module/build/KernelFeatureDetection.mk b/client_module/build/KernelFeatureDetection.mk
index 10534d5..44a23f0 100644
--- a/client_module/build/KernelFeatureDetection.mk
+++ b/client_module/build/KernelFeatureDetection.mk
@@ -257,6 +257,9 @@ $(call define_if_matches, KERNEL_HAS_GENERIC_PERMISSION_2, \
 # fourth arg is a callback on the next line.
 $(call define_if_matches, KERNEL_HAS_GENERIC_PERMISSION_4, \
    -P "extern int generic_permission.struct inode \*. int. unsigned int.", fs.h)
+# variant with userns as first argument
+$(call define_if_matches, KERNEL_HAS_GENERIC_PERMISSION_USERNS, \
+   -P "int generic_permission\(struct user_namespace \*, struct inode \*, int\);", fs.h)
 $(call define_if_matches, KERNEL_HAS_WRITE_ITER, -F "ssize_t (*write_iter)", fs.h)
 $(call define_if_matches, KERNEL_HAS_AIO_WRITE_BUF, \
    -P "ssize_t \(\*aio_write\).*const char", fs.h)
diff --git a/client_module/source/os/OsCompat.h b/client_module/source/os/OsCompat.h
index 219a24b..2be85ad 100644
--- a/client_module/source/os/OsCompat.h
+++ b/client_module/source/os/OsCompat.h
@@ -14,6 +14,7 @@
 #include <linux/posix_acl_xattr.h>
 #include <linux/swap.h>
 #include <linux/writeback.h>
+#include <linux/cred.h>
 
 #include <linux/task_io_accounting_ops.h>
 
@@ -51,6 +52,8 @@ int os_generic_permission(struct inode *inode, int mask)
       return generic_permission(inode, mask);
    #elif defined(KERNEL_HAS_GENERIC_PERMISSION_4)
       return generic_permission(inode, mask, 0, NULL);
+   #elif defined(KERNEL_HAS_GENERIC_PERMISSION_USERNS)
+      return generic_permission(current_user_ns(), inode, mask);
    #else
       return generic_permission(inode, mask, NULL);
    #endif
-- 
2.35.1

